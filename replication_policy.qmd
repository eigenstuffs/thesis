---
title: "replication_policy"
author: "Branden Bohrnsen"
date: "7 February 2024"
format: html
editor: visual
---

### Replication File - Data from [Bergquist and Warshaw (2023)](https://www.nature.com/articles/s41467-023-40560-y)

```{r}
options(scipen = 999)
library(tidyverse)
library(fastDummies)
library(zoo)
set.seed(07151129)
```

Loading data from their replication file

```{r}
panel <- read.csv("panel_data_FEB11.csv")
policies <- read.csv("policies.csv")[,3:29] %>% filter(year >= 1998) # Bergquist & Warshaw 202
```

Modifying data types and joining to panel

```{r}
names(policies)[1:2] <- c("State", "Year")
policies <- policies %>% filter(State != "DC")
```

```{r}
colnames(policies)

policies_temp <- policies %>% select(-x_rps_targets_bindingonly, -z_gasoline_tax, -x_eers)
str(policies_temp)

colnames(policies_temp) <- 
  dplyr::recode(colnames(policies_temp),
                            "abb" = "State", "year" = "Year",
                            "climate_action_plan_21" = "ClimateActionPlan",
                            "netmeter_yearadopted_21" = "NetMeter",
                            "pace_21" = "PACE",
                            "w_ee_21" = "EfficiencyTargets",
                            "w_environment_solar_taxcredit_21" = "ResSolarTaxCredit",
                            "w_low_income_ee_21" = "LowIncomeEff",
                            "public_building_standards" = "PublicBuildingStandards",
                            "w4_electric_decoupling_21" = "ElectricDecoupling",
                            "w4_gas_decoupling_21" = "GasDecoupling",
                         "w_gg_rr_21" = "PowerPlantsReport",
                         "environment_ca_car_emissions_standards_21" = "CACarStandards",
                         "environment_preemption_naturalgasbans" = "ProhibitGasHookupBans",
                         "w4_environment_state_rps_21" = "RPS",
                         "w_ghg_targets_21" = "GHGTargets",
                         "community_solar" = "CommunitySolar",
                         "environment_ghg_cap_21" = "UtilitiesGHGCap",
                         "environment_publicbenefit_funds_21" = "PublicBenefitFunds",
                         "fgd_21" = "FuelSourceDisclosure",
                         "ghg_standards_21" = "PerformanceStandards",
                         "w_complete_streets_21" = "CompleteStreets",
                         "w_environment_state_nepas_21" = "StateNEPA",
                         "w_mgpo_21" = "RenewablesOffered")

carbon_intensity_policies <- c("CommunitySolar", "UtilitiesGHGCap", "FuelSourceDisclosure", "NetMeter","RenewablesOffered", "RPS", "PowerPlantsReport", "ResSolarTaxCredit")

energy_intensity_policies <- c("CACarStandards", "ProhibitGasHookupBans", "PublicBuildingStandards", "CompleteStreets", "EfficiencyTargets", "LowIncomeEff", "ElectricDecoupling", "GasDecoupling", "GasDecoupling")

other_policies <- c("ClimateActionPlan", "PublicBenefitFunds", "PerformanceStandards", "PACE", "StateNEPA", "GHGTargets")

count <- policies_temp %>%
  mutate(sum = rowSums(across(c(-State, -Year)), na.rm = TRUE))

count <- count %>% select(State, Year, sum)
colnames(count)[3] <- "Score"

count <- merge(count, policies %>% select(State, Year, x_rps_targets_bindingonly, z_gasoline_tax, x_eers), by = c("State", "Year"))
count <- merge(count, panel, c("State", "Year"))

## carbon intensity

CI_pol <- policies_temp %>% select(State, Year, all_of(carbon_intensity_policies)) %>%
  mutate(sum = rowSums(across(c(-State, -Year)), na.rm = TRUE))

CI_pol <- CI_pol %>% select(State, Year, sum)
colnames(CI_pol)[3] <- "CI_Score"

## energy intensity

EI_pol <- policies_temp %>% select(State, Year, all_of(energy_intensity_policies)) %>%
  mutate(sum = rowSums(across(c(-State, -Year)), na.rm = TRUE))

EI_pol <- EI_pol %>% select(State, Year, sum)
colnames(EI_pol)[3] <- "EE_Score"

###

other_pol <- policies_temp %>% select(State, Year, all_of(other_policies)) %>%
  mutate(sum = rowSums(across(c(-State, -Year)), na.rm = TRUE))

other_pol <- other_pol %>% select(State, Year, sum)
colnames(other_pol)[3] <- "Other_Score"

###

count <- merge(count, CI_pol, by = c("State", "Year"))
count <- merge(count, EI_pol, by = c("State", "Year"))
count <- merge(count, other_pol, by = c("State", "Year"))

###

write.csv(count, "panel_with_count_FEB11.csv", row.names = FALSE)
```

```{r}
policies_subset <- policies %>% filter(year >= 2005) %>% filter(year <= 2010)

policies_subset <- data.frame(lapply(policies_subset, function(x) na.locf(x, na.rm = FALSE)))

policies_subset <- data.frame(lapply(policies_subset, function(x) {
  rev(na.locf(rev(x), na.rm = FALSE))
}))

policies_subset <- policies_subset %>% select(-environment_preemption_naturalgasbans, -w_low_income_ee_21)

for (col in names(policies_subset %>% select(-year, -abb))) {
  formula <- as.formula(paste(as.factor(col), "~ year"))
  model <- lm(formula, data = policies_subset)
  if (summary(model)$coefficients['year', 'Pr(>|t|)'] < 0.05) {
    print("SIGNIFICANT:")
    print(formula)
    print(summary(model))
  } else {
    print("NOT SIGNIFICANT:")
    print(formula)
  }
}
```
